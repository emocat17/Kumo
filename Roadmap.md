# Roadmap.md - Kumo 爬虫任务管理平台开发规划

## 核心目标
打造一个功能完善、易于管理的**单机/轻量级分布式**爬虫任务管理平台，具备以下核心特性：
- **可视化任务管理与监控** (已实现基础版本，需增强统计分析)
- **灵活的 Python 环境隔离** (已通过 Conda/Venv 实现)
- **高效的资源利用率** (需优化容器资源限制)
- **健壮的任务调度机制** (需补充重试、超时与告警)

---

## 1. 基础架构增强 (Infrastructure)
### 1.1 环境管理模块
- [x] **自定义 pip 镜像源配置**: 支持用户在前端配置 PyPI 镜像源，加速依赖安装。
- [x] **环境变量管理系统**:
    - [x] 全局环境变量配置界面 (API Keys, DB URLs)。
    - [x] 脚本级环境变量继承机制 (注入到 Task `subprocess` 中)。
    - [x] 敏感信息 (`SECRET_KEY`) 加密存储方案。

### 1.2 容器化与部署优化
- [x] **精简 Docker 镜像**: 优化 `backend` 和 `front` 的 Dockerfile，减少构建体积。
- [x] **多阶段构建**: 分离构建环境与运行环境。
- [x] **资源限制**: 在 `docker-compose.yml` 中添加 CPU/Memory 限制配置示例。
- [x] **时区同步**: 修正容器与宿主机时区不一致问题，确保调度准确。

---

## 2. 监控与可视化 (Monitoring & Visualization)
### 2.1 仪表盘增强 (Dashboard)
- [x] **任务执行概览面板**:
    - [x] 统计总任务数、运行中、成功/失败次数。
    - [x] 任务成功率统计 (7天成功率)。
    - [x] **实时状态监控**: 首页显示“正在运行”的任务数量。
- [x] **任务执行趋势分析**:
    - [x] 过去 7 天的任务执行量图表 (每日成功/失败趋势)。
    - [x] **失败任务 TOP 5 统计**: 统计失败次数最多的任务，辅助定位问题。

### 2.2 交互式图表
- [x] **多维度筛选**: 基于项目、时间范围筛选日志和统计数据。
- [ ] **实时刷新**: 优化前端轮询机制，降低后端压力，保证数据实时性。

---

## 3. 任务管理功能 (Task Management)
### 3.1 调度系统升级 (Core)
*目前 Task 模型仅支持基础触发器，需扩展字段支持高级调度。*
- [x] **失败自动重试**:
    - [x] 数据库新增 `retry_count`, `retry_delay` 字段。
    - [x] `task_manager` 实现重试逻辑。
- [x] **任务超时控制**: 新增 `timeout` 字段，强制终止超时任务。
- [x] **任务优先级**: 新增 `priority` 字段，用于调度队列排序 (0=Normal, 1=High, 2=Critical)。
- [x] **Cron 表达式预览**: 在任务创建/编辑时，调用后端 API 验证并预览 Cron 表达式的下 5 次执行时间。

### 3.2 执行监控
- [x] **实时日志优化**: 解决长日志加载性能问题 (已实现：仅读取最后 50KB/200KB，避免浏览器崩溃)。
- [x] **资源占用监控**: 使用 `psutil` 监控子进程的 CPU/内存占用，并记录历史峰值。
- [x] **日志内容搜索**: 支持在日志文件中搜索关键词 (grep)。

### 3.3 任务调度优化
- [x] **任务队列**: 引入 Celery 等任务队列，支持异步执行和批量处理。
- [x] **高性能并发 (Async/ProcessPool)**: 优化任务执行引擎，支持异步并发与进程池调度，充分利用系统资源提升执行效率。
---

## 4. 系统可靠性 (System Reliability)
### 4.1 可靠性与审计
- [x] **操作审计**: 记录关键操作 (删除环境、修改任务) 到审计日志表。
- [x] **数据备份与恢复**:
    - [x] **手动备份**: 支持在前端手动触发数据库备份。
    - [x] **备份下载**: 支持下载备份文件到本地。
    - [x] **自动备份**: 定时备份 `TaskManage.db` (支持自定义间隔与保留策略)。

---

## 5. 分布式扩展 (Future) - 最后再考虑
*当前阶段专注于单机性能与体验，分布式作为长期目标。*
### 5.1 基础集群能力
- [ ] **节点标识**: 完善 `Task.node_id` 逻辑，允许 Worker 节点注册。
- [ ] **任务分发**: 简单的 HTTP 任务分发机制。

---

## 6. 生态集成 (Ecosystem)
### 6.1 框架模板支持
- [x] **项目类型识别**: 自动识别 `scrapy.cfg`, `main.py`, `app.py` 并推荐执行命令。
- [ ] **Selenium/DrissionPage**: 提供包含 Headless 浏览器环境的 Docker 镜像变体。

---

## 实施策略与里程碑

### Phase 1: 稳固基础 (v0.5.0)
- **目标**: 修复现有 Bug，完善环境变量管理，优化 Docker 构建。
- **重点**: 1.1, 1.2
- **说明**: 夯实地基，确保环境构建快、稳、好用，这是任务运行的前提。

### Phase 2: 调度核心升级 (v0.8.0)
- **目标**: 完善任务调度逻辑，引入重试、超时和告警，确保任务执行的健壮性。
- **重点**: 3.1, 3.2
- **说明**: 增强核心业务能力，确保任务"能跑"且"跑得稳"，并产生详细的执行数据。

### Phase 3: 可视化与监控 (v1.0.0)
- **目标**: 基于调度数据构建仪表盘，提供全方位的系统洞察。
- **重点**: 2.1, 2.2, 4.1
- **说明**: 利用 Phase 2 产生的数据进行可视化展示，并完善审计与备份，达到正式版标准。

### Phase 4: 生态与扩展 (v1.5.0+)
- **目标**: 支持更多 Python 爬虫框架模板，探索分布式。
- **重点**: 6.1, 5.1

---

## 质量保证
- **单元测试**: 覆盖核心 `task_manager` 调度逻辑。
- **E2E 测试**: 确保前端操作与后端状态同步。
- **代码规范**: 严格遵循 PEP8 (Black/Flake8) 和 ESLint/Prettier。
