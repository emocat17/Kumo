name: kumo

services:
  # --- Backend Service ---
  backend:
    container_name: backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    volumes:
      # 1. 代码映射：宿主机修改代码，容器内实时生效 (热重载)
      - ./backend:/app
      - ./Data:/data
      
      # 2. 数据持久化：防止重启丢失数据
      - ./backend/data:/app/data        # 数据库 (SQLite)
      - ./backend/projects:/app/projects # 上传的项目文件
      - ./backend/logs:/app/logs        # 运行日志
      - ./backend/envs:/app/envs        # 创建的虚拟环境
      
      # 3. 排除宿主机虚拟环境 (如果存在)
      # - /app/venv
    ports:
      - "8000:8000"
    environment:
      - TZ=Asia/Shanghai
      - PYTHONUNBUFFERED=1
      - WATCHFILES_FORCE_POLLING=true
      - MAX_CONCURRENT_TASKS=50
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/docs || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - kumo-net
    restart: unless-stopped
    # 资源限制示例 (默认注释，可按需开启)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1.0'
    #       memory: 1G

  # --- Frontend Service ---
  front:
    container_name: front
    build:
      context: ./front
      dockerfile: Dockerfile
      target: dev  # 指定构建目标为开发环境
    volumes:
      # 1. 代码映射：宿主机修改代码，容器内实时生效 (HMR)
      - ./front:/app
      
      # 2. 依赖隔离：使用匿名卷，防止宿主机 node_modules 覆盖容器内
      - /app/node_modules
    ports:
      - "6677:6677"
    environment:
      - TZ=Asia/Shanghai
      - VITE_API_BASE_URL=http://backend:8000
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - kumo-net
    restart: unless-stopped
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '0.5'
    #       memory: 512M

networks:
  kumo-net:
    driver: bridge
